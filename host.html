<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一字千金 ‧ 派對爭霸 | 主控端</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        :root{
            --primary:#FF6B35;--secondary:#F7931E;--accent:#FFD23F;
            --correct:#00FF88;--incorrect:#FF3366;
            --bg:linear-gradient(135deg,#0A0E27 0%,#1a1f3a 50%,#0d1129 100%);
        }
        body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:white;overflow:hidden;height:100vh;}

        /* Particles */
        .particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;opacity:0.25;}
        .particle{position:absolute;width:3px;height:3px;background:var(--accent);border-radius:50%;animation:float 15s infinite;}
        @keyframes float{0%,100%{transform:translateY(0);opacity:0;}10%{opacity:1;}90%{opacity:1;}100%{transform:translateY(-100vh) translateX(40px);opacity:0;}}

        /* Overlay screens */
        .screen{position:fixed;top:0;left:0;width:100%;height:100%;z-index:100;
            display:flex;flex-direction:column;justify-content:center;align-items:center;
            background:var(--bg);gap:20px;padding:30px;}
        .screen.hidden{display:none;}

        .screen h1{font-family:'Orbitron',sans-serif;font-size:clamp(2rem,5vw,4rem);
            background:linear-gradient(135deg,var(--primary),var(--secondary),var(--accent));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-align:center;}

        .config-box{width:100%;max-width:520px;background:rgba(0,0,0,0.55);
            border:2px solid var(--primary);border-radius:18px;padding:28px;}
        .field{margin-bottom:16px;}
        .field label{display:block;color:var(--accent);font-size:0.82rem;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;}
        .field input{width:100%;padding:12px;background:rgba(0,0,0,0.7);border:2px solid rgba(255,107,53,0.3);
            border-radius:9px;color:white;font-size:0.95rem;transition:border-color .2s;}
        .field input:focus{outline:none;border-color:var(--primary);}

        .btn-primary{width:100%;padding:15px;background:linear-gradient(135deg,var(--primary),var(--secondary));
            border:none;border-radius:11px;color:white;font-size:1.1rem;font-weight:700;cursor:pointer;
            box-shadow:0 5px 25px rgba(255,107,53,0.4);text-transform:uppercase;margin-top:5px;}
        .btn-primary:active{transform:scale(.98);}
        .btn-green{background:linear-gradient(135deg,var(--correct),#00CC6A);box-shadow:0 5px 25px rgba(0,255,136,0.4);}

        .err{margin-top:10px;color:var(--incorrect);font-size:0.88rem;display:none;}

        /* Room ID display */
        .room-id-big{font-family:'Orbitron',monospace;font-size:clamp(3.5rem,14vw,7rem);font-weight:900;
            color:var(--accent);padding:25px 55px;background:rgba(0,0,0,0.7);
            border:3px solid var(--accent);border-radius:20px;
            box-shadow:0 0 50px rgba(255,211,63,0.5);letter-spacing:18px;}

        .conn-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;max-width:680px;width:100%;}
        .conn-card{background:rgba(0,0,0,0.5);border:2px solid rgba(255,107,53,0.2);
            border-radius:14px;padding:18px;text-align:center;transition:all .3s;}
        .conn-card.on{border-color:var(--correct);box-shadow:0 0 20px rgba(0,255,136,0.3);}
        .conn-card .icon{font-size:2rem;margin-bottom:8px;}
        .conn-card .name{font-size:0.85rem;color:rgba(255,255,255,0.7);margin-bottom:5px;}
        .conn-card .status{font-size:0.75rem;color:#555;}
        .conn-card.on .status{color:var(--correct);}

        /* Main game */
        .game{position:relative;z-index:1;height:100vh;display:flex;flex-direction:column;padding:14px;display:none;}
        .top-bar{display:flex;justify-content:space-between;align-items:center;
            padding:12px 24px;margin-bottom:12px;
            background:rgba(255,107,53,0.1);border:2px solid var(--primary);border-radius:14px;
            box-shadow:0 0 20px rgba(255,107,53,0.3);}
        .logo{font-family:'Orbitron',sans-serif;font-size:clamp(1.1rem,2.5vw,1.8rem);font-weight:900;
            background:linear-gradient(135deg,var(--primary),var(--secondary),var(--accent));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .room-badge{font-family:'Orbitron',monospace;font-size:1.1rem;padding:7px 18px;
            background:rgba(0,0,0,0.5);border:2px solid var(--accent);border-radius:9px;color:var(--accent);}

        .q-area{background:linear-gradient(135deg,rgba(255,107,53,.18),rgba(247,147,30,.08));
            border:3px solid var(--primary);border-radius:18px;padding:18px 24px;
            margin-bottom:12px;position:relative;overflow:hidden;
            box-shadow:0 8px 40px rgba(255,107,53,0.25);}
        .q-area::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
            background:radial-gradient(circle,rgba(255,211,63,.08) 0%,transparent 70%);
            animation:pulse 3s ease-in-out infinite;}
        @keyframes pulse{0%,100%{opacity:.5;}50%{opacity:.9;}}
        .q-label{font-size:.8rem;color:var(--accent);letter-spacing:3px;text-transform:uppercase;position:relative;z-index:1;}
        .q-text{font-size:clamp(1.4rem,3vw,2.4rem);font-weight:900;line-height:1.4;position:relative;z-index:1;margin-top:6px;}
        .timer{position:absolute;top:14px;right:22px;font-family:'Orbitron',monospace;
            font-size:clamp(2rem,4vw,3rem);font-weight:900;color:var(--accent);
            text-shadow:0 0 20px var(--accent);z-index:2;}
        .timer.warn{color:var(--incorrect);animation:blink .5s infinite;}
        @keyframes blink{0%,50%{opacity:1;}51%,100%{opacity:.3;}}

        .players{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;flex:1;min-height:0;}
        .p-card{background:rgba(10,14,39,.85);border:3px solid rgba(255,107,53,.2);
            border-radius:14px;padding:14px;display:flex;flex-direction:column;transition:all .3s;}
        .p-card.on{border-color:var(--primary);box-shadow:0 4px 25px rgba(255,107,53,.35);}
        .p-card.appeal{animation:appeal 1s infinite;}
        @keyframes appeal{
            0%,100%{border-color:var(--accent);box-shadow:0 0 30px var(--accent);}
            50%{border-color:var(--incorrect);box-shadow:0 0 50px var(--incorrect);}
        }
        .p-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
        .p-name{font-family:'Orbitron',sans-serif;font-size:clamp(.9rem,1.8vw,1.4rem);font-weight:700;color:var(--primary);}
        .p-score{font-family:'Orbitron',monospace;font-size:clamp(1.3rem,2.5vw,2rem);font-weight:900;
            color:var(--accent);text-shadow:0 0 15px var(--accent);}
        .canvas-wrap{background:rgba(0,0,0,.5);border:2px solid rgba(255,107,53,.15);
            border-radius:9px;flex:1;min-height:0;position:relative;}
        .p-canvas{width:100%;height:100%;display:block;border-radius:7px;}
        .result{background:rgba(0,0,0,.7);border-radius:9px;padding:10px;
            text-align:center;margin-top:8px;min-height:62px;display:flex;flex-direction:column;justify-content:center;}
        .r-char{font-size:clamp(1.3rem,2.5vw,2.2rem);font-weight:900;margin-bottom:2px;}
        .r-status{font-size:.8rem;text-transform:uppercase;letter-spacing:2px;}
        .result.correct .r-char{color:var(--correct);text-shadow:0 0 20px var(--correct);}
        .result.incorrect .r-char{color:var(--incorrect);text-shadow:0 0 20px var(--incorrect);}
        .result.waiting .r-char{color:#444;}

        .bot-bar{display:flex;justify-content:space-between;align-items:center;
            padding:9px 18px;margin-top:10px;
            background:rgba(0,0,0,.5);border:2px solid rgba(255,107,53,.25);border-radius:11px;}
        .dots{display:flex;gap:14px;}
        .dot-row{display:flex;align-items:center;gap:7px;font-size:.82rem;}
        .dot{width:10px;height:10px;border-radius:50%;background:#333;}
        .dot.on{background:var(--correct);box-shadow:0 0 10px var(--correct);}

        .score-fx{position:fixed;font-size:4.5rem;font-weight:900;font-family:'Orbitron',sans-serif;
            pointer-events:none;animation:sfx 1.4s ease-out forwards;z-index:1000;color:#00FF88;
            text-shadow:0 0 30px #00FF88;}
        @keyframes sfx{0%{transform:scale(0) rotate(-15deg);opacity:0;}
            50%{transform:scale(1.2) rotate(5deg);opacity:1;}
            100%{transform:scale(1) translateY(-180px);opacity:0;}}
    </style>
</head>
<body>
<div class="particles" id="particles"></div>

<!-- Setup screen -->
<div class="screen" id="setupScreen">
    <h1>一字千金 ‧ 派對爭霸</h1>
    <div class="config-box">
        <p style="color:rgba(255,255,255,.65);font-size:.9rem;margin-bottom:18px;line-height:1.7;">
            請填入您的 Firebase 設定，系統將自動建立房間並生成 4 位數字代號。
        </p>
        <div class="field">
            <label>Database URL</label>
            <input id="dbUrl" placeholder="https://your-project-default-rtdb.firebaseio.com" type="url">
        </div>
        <div class="field">
            <label>API Key</label>
            <input id="apiKey" placeholder="AIzaSy..." type="text">
        </div>
        <button class="btn-primary" onclick="initFirebase()">建立房間 ▶</button>
        <div class="err" id="setupErr"></div>
    </div>
</div>

<!-- Waiting screen -->
<div class="screen hidden" id="waitScreen">
    <h1>等待連線中</h1>
    <p style="color:rgba(255,255,255,.6);font-size:1rem;">請讓其他裝置輸入以下房間代號</p>
    <div class="room-id-big" id="roomDisplay">----</div>
    <div class="conn-grid">
        <div class="conn-card" id="cAdmin"><div class="icon">⚙️</div><div class="name">管理員</div><div class="status">等待中</div></div>
        <div class="conn-card" id="cP1"><div class="icon">✍️</div><div class="name">選手 1</div><div class="status">等待中</div></div>
        <div class="conn-card" id="cP2"><div class="icon">✍️</div><div class="name">選手 2</div><div class="status">等待中</div></div>
        <div class="conn-card" id="cP3"><div class="icon">✍️</div><div class="name">選手 3</div><div class="status">等待中</div></div>
    </div>
    <button class="btn-primary btn-green" id="goBtn" onclick="startGame()" style="max-width:320px;display:none;">
        開始遊戲 ▶
    </button>
</div>

<!-- Main game -->
<div class="game" id="game">
    <div class="top-bar">
        <div class="logo">一字千金 ‧ 派對爭霸</div>
        <div class="room-badge">房間 <span id="headerRoom"></span></div>
    </div>

    <div class="q-area">
        <div class="timer" id="timer">30</div>
        <div class="q-label">第 <span id="qNum">--</span> 題</div>
        <div class="q-text" id="qText">等待管理員出題...</div>
    </div>

    <div class="players">
        <div class="p-card" id="pc1">
            <div class="p-head"><span class="p-name">選手 1</span><span class="p-score" id="sc1">0</span></div>
            <div class="canvas-wrap"><canvas class="p-canvas" id="cv1"></canvas></div>
            <div class="result waiting" id="res1"><div class="r-char">---</div><div class="r-status">等待中</div></div>
        </div>
        <div class="p-card" id="pc2">
            <div class="p-head"><span class="p-name">選手 2</span><span class="p-score" id="sc2">0</span></div>
            <div class="canvas-wrap"><canvas class="p-canvas" id="cv2"></canvas></div>
            <div class="result waiting" id="res2"><div class="r-char">---</div><div class="r-status">等待中</div></div>
        </div>
        <div class="p-card" id="pc3">
            <div class="p-head"><span class="p-name">選手 3</span><span class="p-score" id="sc3">0</span></div>
            <div class="canvas-wrap"><canvas class="p-canvas" id="cv3"></canvas></div>
            <div class="result waiting" id="res3"><div class="r-char">---</div><div class="r-status">等待中</div></div>
        </div>
    </div>

    <div class="bot-bar">
        <div class="dots">
            <div class="dot-row"><div class="dot" id="dAdmin"></div><span>管理員</span></div>
            <div class="dot-row"><div class="dot" id="dP1"></div><span>選手 1</span></div>
            <div class="dot-row"><div class="dot" id="dP2"></div><span>選手 2</span></div>
            <div class="dot-row"><div class="dot" id="dP3"></div><span>選手 3</span></div>
        </div>
        <div id="statusMsg">系統就緒</div>
    </div>
</div>

<script>
const QUESTIONS=[
    {"q":"請寫出「ㄨㄢˇ」救的「ㄨㄢˇ」","a":"挽"},{"q":"「再接再厲」的「厲」是否正確？(請寫正字)","a":"厲"},
    {"q":"「寒暄」的「暄」怎麼寫？","a":"暄"},{"q":"請寫出「尷尬」的「尬」","a":"尬"},
    {"q":"成語填空：按部「〇」班","a":"就"},{"q":"「ㄒㄩㄢˊ」染的「ㄒㄩㄢˊ」正確寫法？","a":"渲"},
    {"q":"請寫出「彆扭」的「彆」","a":"彆"},{"q":"成語填空：「〇」竿見影","a":"立"},
    {"q":"「ㄌㄧㄠˊ」闊的「ㄌㄧㄠˊ」正確寫法？","a":"遼"},{"q":"請寫出「蹣跚」的「蹣」","a":"蹣"},
    {"q":"「嫻」熟的「嫻」怎麼寫？","a":"嫻"},{"q":"成語填空：「〇」精會神","a":"聚"},
    {"q":"「ㄐㄧㄝˊ」然不同的「ㄐㄧㄝˊ」正確寫法？","a":"迥"},{"q":"請寫出「懾」服的「懾」","a":"懾"},
    {"q":"「ㄑㄧˋ」而不捨的「ㄑㄧˋ」怎麼寫？","a":"契"},{"q":"成語填空：「〇」手可得","a":"唾"},
    {"q":"「ㄒㄩㄢ」嘩的「ㄒㄩㄢ」正確寫法？","a":"喧"},{"q":"請寫出「慷慨」的「慨」","a":"慨"},
    {"q":"「惆悵」的「惆」怎麼寫？","a":"惆"},{"q":"成語填空：「〇」然大悟","a":"恍"},
    {"q":"「ㄆㄧˇ」睨的「ㄆㄧˇ」正確寫法？","a":"睥"},{"q":"請寫出「蹙」額的「蹙」","a":"蹙"},
    {"q":"「ㄅㄧˋ」端的「ㄅㄧˋ」怎麼寫？","a":"弊"},{"q":"成語填空：「〇」張聲勢","a":"虛"},
    {"q":"「ㄔㄢˊ」悔的「ㄔㄢˊ」正確寫法？","a":"懺"},{"q":"請寫出「嘲諷」的「諷」","a":"諷"},
    {"q":"「怠惰」的「惰」怎麼寫？","a":"惰"},{"q":"成語填空：「〇」飛猛進","a":"突"},
    {"q":"請寫出「訕笑」的「訕」","a":"訕"},{"q":"成語填空：「〇」木求魚","a":"緣"},
    {"q":"「ㄌㄧㄣˊ」憫的「ㄌㄧㄣˊ」正確寫法？","a":"憐"},{"q":"請寫出「嫉妒」的「嫉」","a":"嫉"},
    {"q":"「譏諷」的「譏」怎麼寫？","a":"譏"},{"q":"成語填空：「〇」衷共濟","a":"同"},
    {"q":"請寫出「慰藉」的「藉」","a":"藉"},{"q":"成語填空：「〇」途末路","a":"窮"},
    {"q":"請寫出「瑕疵」的「疵」","a":"疵"},{"q":"「詭」辯的「詭」怎麼寫？","a":"詭"},
    {"q":"成語填空：「〇」極泰來","a":"否"},{"q":"請寫出「揶揄」的「揄」","a":"揄"},
    {"q":"「斟酌」的「酌」怎麼寫？","a":"酌"},{"q":"成語填空：「〇」瓜爛熟","a":"滾"},
    {"q":"請寫出「癖好」的「癖」","a":"癖"},{"q":"「諂媚」的「諂」怎麼寫？","a":"諂"},
    {"q":"成語填空：「〇」然紙上","a":"躍"},{"q":"請寫出「蟄伏」的「蟄」","a":"蟄"},
    {"q":"「ㄓㄨㄛˊ」磨的「ㄓㄨㄛˊ」正確寫法？","a":"琢"},{"q":"請寫出「倔強」的「倔」","a":"倔"},
    {"q":"「嘮叨」的「嘮」怎麼寫？","a":"嘮"},{"q":"成語填空：「〇」不單行","a":"禍"},
    {"q":"請寫出「綺麗」的「綺」","a":"綺"},{"q":"「躊躇」的「躇」怎麼寫？","a":"躇"},
    {"q":"成語填空：「〇」羽而歸","a":"鎩"},{"q":"請寫出「嗔怪」的「嗔」","a":"嗔"},
    {"q":"「霎時」的「霎」怎麼寫？","a":"霎"},{"q":"成語填空：「〇〇」不忘","a":"念念"},
    {"q":"請寫出「窘迫」的「窘」","a":"窘"},{"q":"「詆毀」的「詆」怎麼寫？","a":"詆"},
    {"q":"請寫出「譴責」的「譴」","a":"譴"},{"q":"「癱瘓」的「癱」怎麼寫？","a":"癱"},
    {"q":"請寫出「啜泣」的「啜」","a":"啜"},{"q":"「慫恿」的「慫」怎麼寫？","a":"慫"},
    {"q":"成語填空：「〇」落有致","a":"錯"},{"q":"請寫出「踹踏」的「踹」","a":"踹"},
    {"q":"「賑災」的「賑」怎麼寫？","a":"賑"},{"q":"成語填空：「〇」不經心","a":"漫"},
    {"q":"請寫出「敷衍」的「敷」","a":"敷"},{"q":"「躁動」的「躁」怎麼寫？","a":"躁"},
    {"q":"成語填空：「〇」息相關","a":"息"},{"q":"請寫出「贅述」的「贅」","a":"贅"},
    {"q":"「嘈雜」的「嘈」怎麼寫？","a":"嘈"},{"q":"成語填空：「〇」為觀止","a":"嘆"},
    {"q":"請寫出「悖論」的「悖」","a":"悖"},{"q":"「戕害」的「戕」怎麼寫？","a":"戕"},
    {"q":"成語填空：「〇」道而行","a":"背"},{"q":"請寫出「踉蹌」的「踉」","a":"踉"},
    {"q":"「ㄒㄩㄢˋ」麗的「ㄒㄩㄢˋ」正確寫法？","a":"絢"},{"q":"請寫出「揣摩」的「揣」","a":"揣"},
    {"q":"「ㄔㄢˋ」抖的「ㄔㄢˋ」正確寫法？","a":"顫"},{"q":"成語填空：「〇」極而衰","a":"盛"},
    {"q":"請寫出「蹂躪」的「躪」","a":"躪"},{"q":"成語填空：「〇〇」大計","a":"百年"},
    {"q":"請寫出「褪色」的「褪」","a":"褪"},{"q":"「熾熱」的「熾」怎麼寫？","a":"熾"},
    {"q":"成語填空：「〇」高氣揚","a":"趾"},{"q":"請寫出「瞥見」的「瞥」","a":"瞥"},
    {"q":"「矯正」的「矯」怎麼寫？","a":"矯"},{"q":"成語填空：一「〇」千金","a":"字"},
    {"q":"請寫出「憔悴」的「憔」","a":"憔"},{"q":"成語填空：「〇」壁清野","a":"堅"},
    {"q":"請寫出「蹉跎」的「蹉」","a":"蹉"},{"q":"成語填空：「〇」死一生","a":"九"},
    {"q":"請寫出「懊悔」的「懊」","a":"懊"},{"q":"「ㄈㄟˋ」寢忘食的「ㄈㄟˋ」正確寫法？","a":"廢"}
];

let db, roomId;
let scores=[0,0,0];
let currentQ=null;
let timerInt=null, timeLeft=30;
let ctxs=[];

// ── Firebase init ──
function initFirebase(){
    const dbUrl=document.getElementById('dbUrl').value.trim();
    const apiKey=document.getElementById('apiKey').value.trim();
    const err=document.getElementById('setupErr');
    err.style.display='none';
    if(!dbUrl||!apiKey){err.textContent='請填入 Database URL 和 API Key';err.style.display='block';return;}
    try{
        if(firebase.apps.length===0){
            firebase.initializeApp({apiKey,databaseURL:dbUrl,
                projectId:dbUrl.replace('https://','').split('.')[0]});
        }
        db=firebase.database();
        db.ref('.info/connected').once('value',s=>{
            if(s.val()){createRoom();}
            else{err.textContent='無法連線到 Firebase，請確認 URL 是否正確';err.style.display='block';}
        });
    }catch(e){err.textContent='錯誤：'+e.message;err.style.display='block';}
}

function createRoom(){
    roomId=String(Math.floor(1000+Math.random()*9000));
    document.getElementById('roomDisplay').textContent=roomId;
    document.getElementById('headerRoom').textContent=roomId;
    // Reset room
    db.ref(`rooms/${roomId}`).set({
        status:'waiting',scores:{p1:0,p2:0,p3:0},
        connections:{admin:false,p1:false,p2:false,p3:false}
    });
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('waitScreen').classList.remove('hidden');
    listenConnections();
    listenGame();
}

function listenConnections(){
    db.ref(`rooms/${roomId}/connections`).on('value',snap=>{
        const c=snap.val()||{};
        setCard('cAdmin','dAdmin',c.admin);
        setCard('cP1','dP1',c.p1,'pc1');
        setCard('cP2','dP2',c.p2,'pc2');
        setCard('cP3','dP3',c.p3,'pc3');
        if(c.admin) document.getElementById('goBtn').style.display='block';
    });
}

function setCard(cardId,dotId,on,pcId){
    const card=document.getElementById(cardId);
    const dot=document.getElementById(dotId);
    if(on){
        card.classList.add('on');card.querySelector('.status').textContent='已連線 ✓';
        if(dot)dot.classList.add('on');
        if(pcId)document.getElementById(pcId)?.classList.add('on');
    }else{
        card.classList.remove('on');card.querySelector('.status').textContent='等待中';
        if(dot)dot.classList.remove('on');
    }
}

function listenGame(){
    // New question
    db.ref(`rooms/${roomId}/currentQuestion`).on('value',snap=>{
        const q=snap.val();
        if(!q)return;
        currentQ=q;
        document.getElementById('qNum').textContent=q.number;
        document.getElementById('qText').textContent=q.text;
        resetResults();
        clearAllCanvas();
        startTimer();
    });
    // Strokes
    for(let i=1;i<=3;i++){
        const pi=i;
        db.ref(`rooms/${roomId}/strokes/p${i}`).on('child_added',snap=>{
            drawStroke(pi,snap.val());
        });
    }
    // Submissions
    db.ref(`rooms/${roomId}/submissions`).on('child_added',snap=>{
        const s=snap.val();
        if(s&&currentQ) handleSub(s.playerNumber,s.character,s.id);
    });
    // Appeals
    db.ref(`rooms/${roomId}/appeals`).on('child_added',snap=>{
        const a=snap.val();
        if(a) handleAppeal(a.playerNumber);
    });
    // Overrides
    db.ref(`rooms/${roomId}/overrides`).on('child_added',snap=>{
        const o=snap.val();
        if(o) handleOverride(o.playerNumber,o.correct);
    });
}

function startGame(){
    document.getElementById('waitScreen').classList.add('hidden');
    document.getElementById('game').style.display='flex';
    initCanvases();
    db.ref(`rooms/${roomId}/status`).set('playing');
}

// ── Canvas ──
function initCanvases(){
    for(let i=1;i<=3;i++){
        const cv=document.getElementById(`cv${i}`);
        const wrap=cv.parentElement;
        cv.width=wrap.offsetWidth;cv.height=wrap.offsetHeight;
        const ctx=cv.getContext('2d');
        ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle='#FF6B35';ctx.lineWidth=3;
        ctxs[i-1]=ctx;
    }
}

function drawStroke(n,s){
    const cv=document.getElementById(`cv${n}`);
    const ctx=ctxs[n-1];
    if(!cv||!ctx)return;
    ctx.beginPath();ctx.moveTo(s.x*cv.width,s.y*cv.height);ctx.lineTo(s.x2*cv.width,s.y2*cv.height);ctx.stroke();
}

function clearAllCanvas(){
    for(let i=1;i<=3;i++){
        const cv=document.getElementById(`cv${i}`);
        if(ctxs[i-1]&&cv)ctxs[i-1].clearRect(0,0,cv.width,cv.height);
    }
    db.ref(`rooms/${roomId}/strokes`).remove();
    db.ref(`rooms/${roomId}/submissions`).remove();
    db.ref(`rooms/${roomId}/appeals`).remove();
    db.ref(`rooms/${roomId}/overrides`).remove();
}

// ── Game Logic ──
function resetResults(){
    for(let i=1;i<=3;i++){
        const r=document.getElementById(`res${i}`);
        r.className='result waiting';r.innerHTML='<div class="r-char">---</div><div class="r-status">等待中</div>';
        document.getElementById(`pc${i}`).classList.remove('appeal');
    }
}

function startTimer(){
    if(timerInt)clearInterval(timerInt);
    timeLeft=30;
    const el=document.getElementById('timer');
    el.textContent=30;el.classList.remove('warn');
    timerInt=setInterval(()=>{
        timeLeft--;el.textContent=timeLeft;
        if(timeLeft<=10)el.classList.add('warn');
        if(timeLeft<=0)clearInterval(timerInt);
    },1000);
}

const submitted=new Set();
function handleSub(n,char,id){
    if(submitted.has(id))return;
    submitted.add(id);
    const correct=char===currentQ.answer;
    const r=document.getElementById(`res${n}`);
    r.className=`result ${correct?'correct':'incorrect'}`;
    r.innerHTML=`<div class="r-char">${char}</div><div class="r-status">${correct?'✓ 正確':'✗ 錯誤'}</div>`;
    if(correct){
        scores[n-1]+=10;
        document.getElementById(`sc${n}`).textContent=scores[n-1];
        db.ref(`rooms/${roomId}/scores`).update({[`p${n}`]:scores[n-1]});
        scoreEffect(n);
    }
    db.ref(`rooms/${roomId}/results/p${n}`).set({correct,character:char,ts:Date.now()});
}

function handleAppeal(n){
    document.getElementById(`pc${n}`).classList.add('appeal');
    document.getElementById('statusMsg').textContent=`⚠️ 選手 ${n} 請求審核！`;
}

const overridden=new Set();
function handleOverride(n,correct){
    const key=`${n}-${Date.now()}`;
    document.getElementById(`pc${n}`).classList.remove('appeal');
    const r=document.getElementById(`res${n}`);
    const char=r.querySelector('.r-char').textContent;
    r.className=`result ${correct?'correct':'incorrect'}`;
    r.innerHTML=`<div class="r-char">${char}</div><div class="r-status">${correct?'✓ 覆核通過':'✗ 覆核駁回'}</div>`;
    if(correct){
        scores[n-1]+=10;
        document.getElementById(`sc${n}`).textContent=scores[n-1];
        db.ref(`rooms/${roomId}/scores`).update({[`p${n}`]:scores[n-1]});
        scoreEffect(n);
    }
    db.ref(`rooms/${roomId}/results/p${n}`).update({overridden:true,correct});
}

function scoreEffect(n){
    const card=document.getElementById(`pc${n}`);
    const r=card.getBoundingClientRect();
    const el=document.createElement('div');
    el.className='score-fx';el.textContent='+10';
    el.style.cssText=`left:${r.left+r.width/2}px;top:${r.top+r.height/2}px;`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),1400);
}

// Particles
window.addEventListener('DOMContentLoaded',()=>{
    const c=document.getElementById('particles');
    for(let i=0;i<25;i++){
        const p=document.createElement('div');p.className='particle';
        p.style.cssText=`left:${Math.random()*100}%;animation-delay:${Math.random()*15}s;animation-duration:${10+Math.random()*10}s`;
        c.appendChild(p);
    }
});
</script>
</body>
</html>
