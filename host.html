<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>一字千金 — Host 主控</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.5/peerjs.min.js"></script>
  <style>
    :root{
      --bg:#071026; --panel:#0b1630; --accent:#ffd166; --muted:#9fb3c8;
      --neon: rgba(255,209,102,0.12);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
    }
    html,body{height:100%; margin:0; background:linear-gradient(180deg,var(--bg) 0%, #001022 100%); color:#e6f0f9;}
    .wrap{display:grid; grid-template-columns: 1fr 420px; gap:18px; padding:18px; height:100vh; box-sizing:border-box;}
    .stage{background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.6)); border-radius:12px; padding:18px; display:flex; flex-direction:column; gap:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.6);}
    .header{display:flex; justify-content:space-between; align-items:center;}
    .title{font-size:20px; font-weight:800; letter-spacing:1px; color:var(--accent)}
    .sub{font-size:12px; color:var(--muted)}
    .big-question{flex:0 0 120px; display:flex; align-items:center; justify-content:center; background:linear-gradient(90deg, rgba(255,209,102,0.06), rgba(255,255,255,0.01)); border-radius:8px; font-size:36px; font-weight:700; text-align:center; padding:10px;}
    .row{display:flex; gap:12px;}
    .players{display:grid; grid-template-columns: repeat(3,1fr); gap:12px; flex:1; align-items:stretch;}
    .player-card{background:var(--panel); border-radius:8px; padding:10px; min-height:220px; position:relative; overflow:hidden;}
    .player-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
    .player-name{font-weight:700}
    .score{font-size:20px; color:var(--accent); font-weight:800}
    .canvas-wrap{background:#000; border-radius:6px; height:120px; overflow:hidden; display:flex; align-items:center; justify-content:center;}
    canvas{width:100%; height:100%; image-rendering:pixelated;}
    .controls{display:flex; gap:8px; align-items:center;}
    .btn{background:var(--accent); color:#042036; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; border:none;}
    .muted{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); padding:8px 10px; border-radius:8px;}
    .sidebar{background:linear-gradient(180deg,#071722 0%, #02111a 100%); border-radius:12px; padding:16px; display:flex; flex-direction:column; gap:12px;}
    .peerid{font-family:monospace; font-weight:700; font-size:13px; color:var(--accent); background:rgba(255,209,102,0.06); padding:8px; border-radius:6px;}
    .list{display:flex; flex-direction:column; gap:8px; max-height:280px; overflow:auto;}
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px}
    .dot-off{background:#2b3b4a} .dot-on{background:#36d399}
    .timer{font-size:36px; font-weight:800; color:#ffd166; text-shadow:0 6px 18px rgba(255,209,102,0.12)}
    .flash{animation:flash 1s infinite}
    @keyframes flash{0%{box-shadow:0 0 0 rgba(255,50,50,0.0)}50%{box-shadow:0 10px 30px rgba(255,50,50,0.18)}100%{box-shadow:0 0 0 rgba(255,50,50,0.0)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stage">
      <div class="header">
        <div>
          <div class="title">一字千金 · 派對爭霸 — 主控 (Host)</div>
          <div class="sub">請在主控端（大螢幕）顯示題目、同步選手筆跡、計分與申訴提示</div>
        </div>
        <div style="text-align:right">
          <div id="hostId" class="peerid">生成 PeerID 中...</div>
          <div style="margin-top:6px" class="sub">連線數：<span id="connCount">0</span></div>
        </div>
      </div>

      <div class="big-question" id="questionDisplay">等待管理員觸發下一題…</div>

      <div class="row" style="align-items:center">
        <div style="flex:1; display:flex; gap:12px; align-items:center;">
          <div class="controls">
            <button id="startTimer" class="btn">開始倒數</button>
            <button id="stopTimer" class="muted">停止</button>
            <button id="clearAll" class="muted">清除畫面</button>
          </div>
          <div style="margin-left:12px" class="sub">當選手按下送出時，系統會自動以題庫答案比對並計分。</div>
        </div>
        <div style="width:240px; text-align:right">
          <div class="sub">倒數</div>
          <div class="timer" id="timerDisplay">--</div>
        </div>
      </div>

      <div class="players" id="players">
        <!-- 3 player cards -->
        <div class="player-card" data-slot="1">
          <div class="player-header">
            <div>
              <div class="player-name">Player 1</div>
              <div class="sub">狀態：<span id="p1status">離線</span></div>
            </div>
            <div class="score" id="p1score">0</div>
          </div>
          <div class="canvas-wrap">
            <canvas id="canvas1" width="600" height="240"></canvas>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div class="sub">辨識：<span id="p1recognized">—</span></div>
            <div><button class="muted" id="p1override">覆核</button></div>
          </div>
        </div>

        <div class="player-card" data-slot="2">
          <div class="player-header">
            <div>
              <div class="player-name">Player 2</div>
              <div class="sub">狀態：<span id="p2status">離線</span></div>
            </div>
            <div class="score" id="p2score">0</div>
          </div>
          <div class="canvas-wrap">
            <canvas id="canvas2" width="600" height="240"></canvas>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div class="sub">辨識：<span id="p2recognized">—</span></div>
            <div><button class="muted" id="p2override">覆核</button></div>
          </div>
        </div>

        <div class="player-card" data-slot="3">
          <div class="player-header">
            <div>
              <div class="player-name">Player 3</div>
              <div class="sub">狀態：<span id="p3status">離線</span></div>
            </div>
            <div class="score" id="p3score">0</div>
          </div>
          <div class="canvas-wrap">
            <canvas id="canvas3" width="600" height="240"></canvas>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div class="sub">辨識：<span id="p3recognized">—</span></div>
            <div><button class="muted" id="p3override">覆核</button></div>
          </div>
        </div>
      </div>
    </div>

    <aside class="sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">控制面板</div>
        <div class="sub">Admin 連線待命</div>
      </div>

      <div>
        <div class="sub">目前題庫狀態</div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <div class="muted">題庫大小：<strong id="bankSize">100</strong></div>
          <div class="muted">已出題：<strong id="askedCount">0</strong></div>
        </div>
      </div>

      <div>
        <div class="sub">連線列表</div>
        <div class="list" id="connList"></div>
      </div>

      <div>
        <div class="sub">管理操作（來自 Admin）</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div class="muted">Admin ID：<span id="adminId">-</span></div>
        </div>
      </div>

      <div style="margin-top:auto">
        <div class="sub">說明</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.4">
          1. Admin 透過 peer id 連線並可送出「下一題」與覆核命令。<br>
          2. Player 即時傳送筆跡（百分比座標），Host 會繪製並在 Player 送出時顯示辨識文字與自動判定。<br>
          3. 若需更穩定部署，請自建 PeerServer / TURN server。
        </div>
      </div>
    </aside>
  </div>

  <!-- ===========================
       100 題題庫（JSON） — 不重複、已包含各類題型
       =========================== -->
  <script>
  // 題庫（100 題） - 格式: {q: "題目描述", a: "正確字或詞"}
  const QUESTION_BANK = [
{"q":"請寫出「ㄨㄢˇ」救的「ㄨㄢˇ」","a":"挽"},
{"q":"「再接再厲」的「厲」正字為何？","a":"厲"},
{"q":"「寒暄」的「暄」怎麼寫？","a":"暄"},
{"q":"請寫出「尷尬」的「尬」","a":"尬"},
{"q":"成語填空：按部「〇」班","a":"就"},
{"q":"請寫出「驚嘆號」的「驚」字","a":"驚"},
{"q":"「鞏固」的「鞏」怎麼寫？","a":"鞏"},
{"q":"「滄海桑田」的「滄」字","a":"滄"},
{"q":"「孜孜不倦」的「孜」寫法","a":"孜"},
{"q":"「冗長」的「冗」","a":"冗"},
{"q":"請寫出「馴服」的「馴」","a":"馴"},
{"q":"「憐憫」的「憐」字","a":"憐"},
{"q":"「勉強」的「勉」怎麼寫？","a":"勉"},
{"q":"「瞭解」的「瞭」正字","a":"瞭"},
{"q":"「斟酌」的「斟」字","a":"斟"},
{"q":"「矯正」的「矯」怎麼寫？","a":"矯"},
{"q":"「膚淺」的「膚」字","a":"膚"},
{"q":"「昏厥」的「厥」寫法","a":"厥"},
{"q":"成語填空：畫蛇添「〇」","a":"足"},
{"q":"「瀟灑」的「灑」正字","a":"灑"},
{"q":"「嫻熟」的「嫻」怎麼寫？","a":"嫻"},
{"q":"「鎮定」的「鎮」字","a":"鎮"},
{"q":"「梳理」的「梳」寫法","a":"梳"},
{"q":"「睏倦」正確字為何？（常寫作「困倦」）","a":"睏"},
{"q":"「誼」字如何拼音與寫法？（請寫正字）","a":"誼"},
{"q":"「讚嘆」的「讚」怎麼寫？","a":"讚"},
{"q":"「囑咐」的「囑」正字","a":"囑"},
{"q":"「撼動」的「撼」寫法","a":"撼"},
{"q":"成語填空：如火如「〇」","a":"荼"},
{"q":"「殷勤」的「殷」怎麼寫？","a":"殷"},
{"q":"「刁難」的「刁」字","a":"刁"},
{"q":"「檢討」的「檢」正字","a":"檢"},
{"q":"「匱乏」的「匱」寫法","a":"匱"},
{"q":"「躊躇滿志」的「躊」寫法","a":"躊"},
{"q":"「曖昧」的「曖」怎麼寫？","a":"曖"},
{"q":"「渾然天成」的「渾」字","a":"渾"},
{"q":"「矚目」的「矚」寫法","a":"矚"},
{"q":"「撥雲見日」的「撥」字","a":"撥"},
{"q":"「瑣碎」的「瑣」怎麼寫？","a":"瑣"},
{"q":"「惘然若失」的「惘」寫法","a":"惘"},
{"q":"「豁然開朗」的「豁」字","a":"豁"},
{"q":"「讚揚」的「揚」正字","a":"揚"},
{"q":"「豐沛」的「沛」寫法","a":"沛"},
{"q":"成語填空：風起雲「〇」","a":"湧"},
{"q":"「敲詐」的「敲」怎麼寫？","a":"敲"},
{"q":"「躡手躡腳」的「躡」正字","a":"躡"},
{"q":"「箴言」的「箴」寫法","a":"箴"},
{"q":"「恪守」的「恪」怎麼寫？","a":"恪"},
{"q":"「鴻溝」的「鴻」字","a":"鴻"},
{"q":"「孵化」的「孵」寫法","a":"孵"},
{"q":"「黯然失色」的「黯」寫法","a":"黯"},
{"q":"「慟哭」的「慟」怎麼寫？","a":"慟"},
{"q":"「羈絆」的「羈」正字","a":"羈"},
{"q":"成語填空：鞠躬盡「〇」","a":"瘁"},
{"q":"「瀉藥」的「瀉」怎麼寫？（注意與「泄」異）","a":"瀉"},
{"q":"「樓閣」的「閣」寫法","a":"閣"},
{"q":"「頑強」的「頑」正字","a":"頑"},
{"q":"「鹹」字在成語「酸甜苦辣」裡屬何義？（寫字）","a":"鹹"},
{"q":"「躍然紙上」的「躍」怎麼寫？","a":"躍"},
{"q":"「酗酒」的「酗」寫法","a":"酗"},
{"q":"「漸近」的「漸」正字","a":"漸"},
{"q":"「愚昧」的「昧」怎麼寫？","a":"昧"},
{"q":"「淬鍊」的「淬」寫法","a":"淬"},
{"q":"「斧鑿」的「鑿」怎麼寫？","a":"鑿"},
{"q":"「躊躇」的「躇」正字（與第 32 題不同）","a":"躇"},
{"q":"「悸動」的「悸」寫法","a":"悸"},
{"q":"成語填空：天翻地「〇」","a":"覆"},
{"q":"「惻隱」的「惻」怎麼寫？","a":"惻"},
{"q":"「曜石」的「曜」寫法","a":"曜"},
{"q":"「礙手礙腳」的「礙」字","a":"礙"},
{"q":"「睥睨」的「睥」怎麼寫？","a":"睥"},
{"q":"「蹣跚」的「蹣」寫法","a":"蹣"},
{"q":"「諍言」的「諍」正字","a":"諍"},
{"q":"「豐潤」的「潤」怎麼寫？","a":"潤"},
{"q":"「蹉跎」的「蹉」寫法","a":"蹉"},
{"q":"成語填空：驚天動「〇」","a":"地"},
{"q":"「歧視」的「歧」怎麼寫？","a":"歧"},
{"q":"「枯槁」的「槁」寫法","a":"槁"},
{"q":"「匍匐」的「匍」正字","a":"匍"},
{"q":"「跋扈」的「跋」怎麼寫？","a":"跋"},
{"q":"「碩果僅存」的「碩」寫法","a":"碩"},
{"q":"「懺悔」的「懺」怎麼寫？","a":"懺"},
{"q":"「惆悵」的「惆」寫法","a":"惆"},
{"q":"「轟動」的「轟」正字","a":"轟"},
{"q":"「綢緞」的「綢」怎麼寫？","a":"綢"},
{"q":"「朦朧」的「朦」寫法","a":"朦"},
{"q":"成語填空：因小失「〇」","a":"大"},
{"q":"「頌讚」的「頌」怎麼寫？","a":"頌"},
{"q":"「祕密」的「祕」正字（與「秘」異體）","a":"祕"},
{"q":"「皓首窮經」的「皓」寫法","a":"皓"},
{"q":"「縝密」的「縝」怎麼寫？","a":"縝"},
{"q":"「曠達」的「曠」寫法","a":"曠"},
{"q":"「滯留」的「滯」正字","a":"滯"},
{"q":"「詭譎」的「譎」怎麼寫？","a":"譎"},
{"q":"「矍鑠」的「矍」寫法","a":"矍"},
{"q":"成語填空：有口無「〇」","a":"言"},
{"q":"「娓娓道來」的「娓」怎麼寫？","a":"娓"},
{"q":"「殷紅」的「殷」與第 28 題相同嗎？（請寫字）","a":"殷"},
{"q":"「傲睨一世」的「睨」寫法","a":"睨"},
{"q":"「蔚藍」的「蔚」怎麼寫？","a":"蔚"},
{"q":"「蟬聯」的「蟬」寫法","a":"蟬"},
{"q":"「疏忽」的「疏」怎麼寫？","a":"疏"},
{"q":"成語填空：推己及「〇」","a":"人"},
{"q":"「饒舌」的「饒」寫法","a":"饒"},
{"q":"「潛伏」的「潛」怎麼寫？","a":"潛"},
{"q":"「怯懦」的「怯」寫法","a":"怯"}
  ];
  </script>

  <script>
  /***************
   Host 主控程式邏輯 (簡化實作)
   - 接受 Player 與 Admin 的連線
   - Player 傳送 'stroke' (百分比座標) 與 'submit' (辨識文字)
   - Host 繪製每位 Player 的小 Canvas（同步即時筆跡）
   - 自動比對答案並計分；Admin 可以覆核並強制改分（覆核訊息由 Admin 傳送）
   ***************/

  // 配置 (如需自建 PeerServer，請在 peerOptions 填入 host/port/key)
  const peerOptions = {
    // example: { host: 'your-peer-server.example', port: 9000, path: '/peerjs' }
  };

  const peer = new Peer(undefined, peerOptions);
  const players = {}; // map slot -> {conn, peerId, name, score}
  let adminConn = null;
  let currentQuestion = null;
  let askedIndices = new Set();

  // UI refs
  const hostIdEl = document.getElementById('hostId');
  const connCountEl = document.getElementById('connCount');
  const connListEl = document.getElementById('connList');
  const bankSizeEl = document.getElementById('bankSize');
  const askedCountEl = document.getElementById('askedCount');
  const adminIdEl = document.getElementById('adminId');
  const questionDisplay = document.getElementById('questionDisplay');
  const timerDisplay = document.getElementById('timerDisplay');

  // canvases
  const canvases = {
    1: document.getElementById('canvas1'),
    2: document.getElementById('canvas2'),
    3: document.getElementById('canvas3'),
  };
  const ctxs = {1:null,2:null,3:null};
  for (let i=1;i<=3;i++){
    const c=canvases[i];
    c.width=600; c.height=240;
    ctxs[i]=c.getContext('2d');
    ctxs[i].fillStyle='#000'; ctxs[i].fillRect(0,0,c.width,c.height);
    ctxs[i].strokeStyle='#0ff'; ctxs[i].lineWidth=3; ctxs[i].lineJoin='round'; ctxs[i].lineCap='round';
  }

  // Peer setup
  peer.on('open', id=>{
    hostIdEl.textContent = `Host ID: ${id}`;
  });

  peer.on('connection', conn=>{
    conn.on('open', ()=>{
      // first message expected: init with role
      conn.on('data', msg=>{
        if (msg && msg.type === 'init') {
          if (msg.role === 'player') {
            // msg: {type:'init', role:'player', slot:1..3, name:'隊名'}
            const slot = msg.slot;
            players[slot] = players[slot] || {};
            players[slot].conn = conn;
            players[slot].peerId = conn.peer;
            players[slot].name = msg.name || `Player ${slot}`;
            players[slot].score = players[slot].score || 0;
            updateConnList();
            setPlayerStatus(slot, true);
            // attach data handler for player
            conn.on('data', data=>{
              handlePlayerMessage(slot, data);
            });
            conn.on('close', ()=>{ setPlayerStatus(slot,false); delete players[slot].conn; updateConnList(); });
          } else if (msg.role === 'admin') {
            adminConn = conn;
            adminIdEl.textContent = conn.peer;
            updateConnList();
            conn.on('data', data=>{
              handleAdminMessage(data);
            });
            conn.on('close', ()=>{ adminConn=null; adminIdEl.textContent='-'; updateConnList(); });
          }
        }
      });
      updateConnList();
    });
  });

  function updateConnList(){
    const items = [];
    let count=0;
    for (let s=1;s<=3;s++){
      const p = players[s];
      if (p && p.conn && p.conn.open) {
        count++;
        items.push(`<div><span class="status-dot dot-on"></span> ${p.name} (${p.peerId}) — 預設分數 ${p.score}</div>`);
      } else {
        items.push(`<div><span class="status-dot dot-off"></span> Player ${s}（未連線）</div>`);
      }
    }
    connListEl.innerHTML = items.join('');
    connCountEl.textContent = count + (adminConn ? 1 : 0);
  }
  function setPlayerStatus(slot, online){
    document.getElementById(`p${slot}status`).textContent = online ? '連線中' : '離線';
    updateConnList();
  }

  // 當 Player 發送訊息
  function handlePlayerMessage(slot, data){
    if (!data || !data.type) return;
    if (data.type === 'stroke') {
      // data: {type:'stroke', points: [{xPercent,yPercent}], color?}
      drawRemoteStroke(slot, data.points, data.color || '#0ff', data.width || 3);
    } else if (data.type === 'submit') {
      // data: {type:'submit', recognized: '文字'}
      handleSubmit(slot, data.recognized);
    } else if (data.type === 'request_review') {
      // show flash on player card
      flashPlayerCard(slot);
      // notify admin
      if (adminConn && adminConn.open) adminConn.send({type:'player_request_review', slot, peer: players[slot]?.peerId});
    }
  }

  // Draw strokes (receive percent coordinates; convert to canvas coords)
  function drawRemoteStroke(slot, points, color, width){
    const c = canvases[slot];
    const ctx = ctxs[slot];
    if (!points || points.length===0) return;
    ctx.save();
    ctx.strokeStyle = color;
    ctx.lineWidth = width;
    ctx.beginPath();
    points.forEach((pt, idx)=>{
      const x = pt.x * c.width;
      const y = pt.y * c.height;
      if (idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    ctx.restore();
  }

  // 提交處理（自動比對）
  function handleSubmit(slot, recognized){
    const idx = currentQuestion?.index;
    const answer = currentQuestion?.a || '';
    // Normalize
    const got = (recognized||'').trim();
    const expect = (answer||'').trim();
    const correct = (got === expect);
    // Update UI
    document.getElementById(`p${slot}recognized`).textContent = got || '—';
    if (correct) {
      players[slot].score = (players[slot].score||0) + 10; // 每題 10 分
      document.getElementById(`p${slot}score`).textContent = players[slot].score;
      // visual effect
      flashScore(slot);
    }
    // send judgement result back to player
    if (players[slot].conn && players[slot].conn.open) {
      players[slot].conn.send({type:'judgement', slot, correct, recognized: got, answer: expect});
    }
    // notify admin of result
    if (adminConn && adminConn.open) {
      adminConn.send({type:'player_result', slot, recognized: got, correct, score: players[slot].score});
    }
  }

  // Admin message handler
  function handleAdminMessage(msg){
    if (!msg || !msg.type) return;
    if (msg.type === 'next_question') {
      pickNextQuestion(msg.mode || 'random');
    } else if (msg.type === 'override') {
      // {type:'override', slot, mark: true/false}
      const slot = msg.slot;
      const mark = !!msg.mark;
      // force adjust score: if mark true and not previously correct -> +10; if mark false and previously added -> -10
      // For simplicity we just set last judgement to mark
      if (mark) {
        players[slot].score = (players[slot].score||0) + 10;
      } else {
        players[slot].score = Math.max(0,(players[slot].score||0)-10);
      }
      document.getElementById(`p${slot}score`).textContent = players[slot].score;
      // notify player
      if (players[slot].conn && players[slot].conn.open) {
        players[slot].conn.send({type:'override_result', slot, mark});
      }
    }
  }

  // Helper: pick next question
  function pickNextQuestion(mode='random'){
    if (askedIndices.size >= QUESTION_BANK.length) {
      questionDisplay.textContent = '題庫已出完';
      return;
    }
    let idx;
    if (mode === 'sequential') {
      for (let i=0;i<QUESTION_BANK.length;i++){
        if (!askedIndices.has(i)){ idx=i; break; }
      }
    } else {
      do { idx = Math.floor(Math.random() * QUESTION_BANK.length); } while (askedIndices.has(idx));
    }
    askedIndices.add(idx);
    currentQuestion = Object.assign({index: idx}, QUESTION_BANK[idx]);
    questionDisplay.textContent = currentQuestion.q;
    askedCountEl.textContent = askedIndices.size;
    broadcastToPlayers({type:'new_question', q: currentQuestion.q, index: idx});
    // clear canvases for new round
    clearAllCanvases();
  }

  function broadcastToPlayers(obj){
    for (let s=1;s<=3;s++){
      const p = players[s];
      if (p && p.conn && p.conn.open){
        p.conn.send(obj);
      }
    }
  }

  // Timer (host-side)
  let timerInterval = null;
  function startTimer(seconds=30){
    clearTimer();
    let t = seconds;
    timerDisplay.textContent = t;
    timerInterval = setInterval(()=>{
      t--;
      if (t<0){ clearTimer(); timerDisplay.textContent='0'; broadcastToPlayers({type:'time_up'}); return; }
      timerDisplay.textContent = t;
    },1000);
  }
  function clearTimer(){ if (timerInterval) clearInterval(timerInterval); timerInterval=null; timerDisplay.textContent='--'; }

  // UI bind
  document.getElementById('startTimer').addEventListener('click',()=> startTimer(30));
  document.getElementById('stopTimer').addEventListener('click', ()=> clearTimer());
  document.getElementById('clearAll').addEventListener('click', ()=> clearAllCanvases());

  function clearAllCanvases(){
    for (let s=1;s<=3;s++){
      const c = canvases[s];
      const ctx = ctxs[s];
      ctx.clearRect(0,0,c.width,c.height);
      ctx.fillStyle='#000'; ctx.fillRect(0,0,c.width,c.height);
      document.getElementById(`p${s}recognized`).textContent='—';
    }
  }

  function flashPlayerCard(slot){
    const card = document.querySelector(`.player-card[data-slot="${slot}"]`);
    if (!card) return;
    card.classList.add('flash');
    setTimeout(()=>card.classList.remove('flash'), 4000);
  }
  function flashScore(slot){
    const el = document.getElementById(`p${slot}score`);
    el.classList.add('flash');
    setTimeout(()=>el.classList.remove('flash'), 1600);
  }

  // Admin override buttons (quick action from host UI)
  document.getElementById('p1override').addEventListener('click', ()=> {
    if (!confirm('將 Player1 判定為正確（+10）？')) return;
    if (players[1] && players[1].conn && players[1].conn.open){
      players[1].score = (players[1].score||0)+10; document.getElementById('p1score').textContent = players[1].score;
      players[1].conn.send({type:'override_result', slot:1, mark:true});
      if (adminConn && adminConn.open) adminConn.send({type:'player_result', slot:1, recognized:'(覆核) 正確', correct:true, score:players[1].score});
    }
  });
  document.getElementById('p2override').addEventListener('click', ()=> {
    if (!confirm('將 Player2 判定為正確（+10）？')) return;
    if (players[2] && players[2].conn && players[2].conn.open){
      players[2].score = (players[2].score||0)+10; document.getElementById('p2score').textContent = players[2].score;
      players[2].conn.send({type:'override_result', slot:2, mark:true});
      if (adminConn && adminConn.open) adminConn.send({type:'player_result', slot:2, recognized:'(覆核) 正確', correct:true, score:players[2].score});
    }
  });
  document.getElementById('p3override').addEventListener('click', ()=> {
    if (!confirm('將 Player3 判定為正確（+10）？')) return;
    if (players[3] && players[3].conn && players[3].conn.open){
      players[3].score = (players[3].score||0)+10; document.getElementById('p3score').textContent = players[3].score;
      players[3].conn.send({type:'override_result', slot:3, mark:true});
      if (adminConn && adminConn.open) adminConn.send({type:'player_result', slot:3, recognized:'(覆核) 正確', correct:true, score:players[3].score});
    }
  });

  // Optional: Admin can connect and send 'next_question' or 'override' messages to host (handled above)

  // Safety: inform user if PeerJS server issues (console)
  peer.on('error', err => {
    console.error('Peer error', err);
    alert('PeerJS 錯誤：' + err);
  });

  // show bank size
  bankSizeEl.textContent = QUESTION_BANK.length;
  askedCountEl.textContent = askedIndices.size;

  </script>
</body>
</html>
