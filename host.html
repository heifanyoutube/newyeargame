<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一字千金 ‧ 派對爭霸 | 主控端</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FF6B35;
            --secondary: #F7931E;
            --accent: #FFD23F;
            --correct: #00FF88;
            --incorrect: #FF3366;
            --bg-dark: #0A0E27;
            --bg-gradient: linear-gradient(135deg, #0A0E27 0%, #1a1f3a 50%, #0d1129 100%);
            --glow: 0 0 20px rgba(255, 107, 53, 0.5);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-gradient);
            color: white;
            overflow: hidden;
            height: 100vh;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.3;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--accent);
            border-radius: 50%;
            animation: float 15s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(50px); opacity: 0; }
        }

        .container {
            position: relative;
            z-index: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 30px;
            background: rgba(255, 107, 53, 0.1);
            border: 2px solid var(--primary);
            border-radius: 15px;
            box-shadow: var(--glow);
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 107, 53, 0.5);
            letter-spacing: 2px;
        }

        .peer-id-display {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--accent);
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(255, 211, 63, 0.3);
        }

        /* Question Display */
        .question-area {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.2), rgba(247, 147, 30, 0.1));
            border: 3px solid var(--primary);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 50px rgba(255, 107, 53, 0.3), inset 0 0 50px rgba(255, 107, 53, 0.05);
            position: relative;
            overflow: hidden;
        }

        .question-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 211, 63, 0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .question-label {
            font-size: 1rem;
            color: var(--accent);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
            position: relative;
            z-index: 1;
        }

        .question-text {
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 1;
            line-height: 1.4;
        }

        .timer {
            position: absolute;
            top: 20px;
            right: 30px;
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            font-weight: 900;
            color: var(--accent);
            text-shadow: 0 0 20px var(--accent);
            z-index: 2;
        }

        .timer.warning {
            color: var(--incorrect);
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* Players Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            flex: 1;
        }

        .player-card {
            background: rgba(10, 14, 39, 0.8);
            border: 3px solid rgba(255, 107, 53, 0.3);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .player-card.connected {
            border-color: var(--primary);
            box-shadow: 0 5px 30px rgba(255, 107, 53, 0.4);
        }

        .player-card.appeal {
            animation: appeal-pulse 1s infinite;
            border-color: var(--accent);
        }

        @keyframes appeal-pulse {
            0%, 100% { 
                border-color: var(--accent);
                box-shadow: 0 0 30px var(--accent), 0 0 60px var(--accent);
            }
            50% { 
                border-color: var(--incorrect);
                box-shadow: 0 0 50px var(--incorrect), 0 0 100px var(--incorrect);
            }
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
        }

        .player-score {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent);
            text-shadow: 0 0 15px var(--accent);
        }

        .canvas-container {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 107, 53, 0.2);
            border-radius: 10px;
            flex: 1;
            position: relative;
            margin-bottom: 15px;
        }

        .player-canvas {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 8px;
        }

        .result-display {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .result-char {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 5px;
        }

        .result-status {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .result-display.correct .result-char {
            color: var(--correct);
            text-shadow: 0 0 20px var(--correct);
        }

        .result-display.incorrect .result-char {
            color: var(--incorrect);
            text-shadow: 0 0 20px var(--incorrect);
        }

        .result-display.waiting .result-char {
            color: #666;
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 107, 53, 0.3);
            border-radius: 15px;
            margin-top: 20px;
        }

        .connection-status {
            display: flex;
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            box-shadow: 0 0 10px #666;
        }

        .status-dot.active {
            background: var(--correct);
            box-shadow: 0 0 15px var(--correct);
            animation: dot-pulse 2s infinite;
        }

        @keyframes dot-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Score Effect */
        .score-effect {
            position: fixed;
            font-size: 5rem;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            pointer-events: none;
            animation: score-popup 1.5s ease-out forwards;
            z-index: 1000;
        }

        @keyframes score-popup {
            0% { transform: scale(0) rotate(-15deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) translateY(-200px) rotate(0deg); opacity: 0; }
        }

        .waiting-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            gap: 40px;
        }

        .waiting-screen h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 4rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 3s ease infinite;
        }

        @keyframes gradient-shift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(30deg); }
        }

        .waiting-screen .peer-id {
            font-family: 'Orbitron', monospace;
            font-size: 5rem;
            color: var(--accent);
            padding: 40px 80px;
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid var(--accent);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(255, 211, 63, 0.5);
            letter-spacing: 15px;
            font-weight: 900;
        }

        .connection-instructions {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            max-width: 600px;
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <div class="waiting-screen" id="waitingScreen">
        <h1>一字千金 ‧ 派對爭霸</h1>
        <div class="peer-id" id="displayPeerId">正在初始化...</div>
        <div class="connection-instructions">
            請在選手端和管理端輸入上方 ID 以連線
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <div class="logo">一字千金 ‧ 派對爭霸</div>
            <div class="peer-id-display">ID: <span id="headerPeerId"></span></div>
        </div>

        <div class="question-area">
            <div class="timer" id="timer">30</div>
            <div class="question-label">第 <span id="questionNumber">1</span> 題</div>
            <div class="question-text" id="questionText">等待管理員開始題目...</div>
        </div>

        <div class="players-grid">
            <div class="player-card" id="player1Card">
                <div class="player-header">
                    <div class="player-name">選手 1</div>
                    <div class="player-score" id="score1">0</div>
                </div>
                <div class="canvas-container">
                    <canvas class="player-canvas" id="canvas1"></canvas>
                </div>
                <div class="result-display waiting" id="result1">
                    <div class="result-char">---</div>
                    <div class="result-status">等待中</div>
                </div>
            </div>

            <div class="player-card" id="player2Card">
                <div class="player-header">
                    <div class="player-name">選手 2</div>
                    <div class="player-score" id="score2">0</div>
                </div>
                <div class="canvas-container">
                    <canvas class="player-canvas" id="canvas2"></canvas>
                </div>
                <div class="result-display waiting" id="result2">
                    <div class="result-char">---</div>
                    <div class="result-status">等待中</div>
                </div>
            </div>

            <div class="player-card" id="player3Card">
                <div class="player-header">
                    <div class="player-name">選手 3</div>
                    <div class="player-score" id="score3">0</div>
                </div>
                <div class="canvas-container">
                    <canvas class="player-canvas" id="canvas3"></canvas>
                </div>
                <div class="result-display waiting" id="result3">
                    <div class="result-char">---</div>
                    <div class="result-status">等待中</div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="connection-status">
                <div class="status-item">
                    <div class="status-dot" id="adminDot"></div>
                    <span>管理員</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="player1Dot"></div>
                    <span>選手 1</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="player2Dot"></div>
                    <span>選手 2</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="player3Dot"></div>
                    <span>選手 3</span>
                </div>
            </div>
            <div id="statusMessage">系統就緒</div>
        </div>
    </div>

    <script>
        // 100題題庫
        const QUESTIONS = [
            {"q": "請寫出「ㄨㄢˇ」救的「ㄨㄢˇ」", "a": "挽"},
            {"q": "「再接再厲」的「厲」是否正確？(請寫正字)", "a": "厲"},
            {"q": "「寒暄」的「暄」怎麼寫？", "a": "暄"},
            {"q": "請寫出「尷尬」的「尬」", "a": "尬"},
            {"q": "成語填空：按部「〇」班", "a": "就"},
            {"q": "「ㄒㄩㄢˊ」染的「ㄒㄩㄢˊ」正確寫法？", "a": "渲"},
            {"q": "請寫出「彆扭」的「彆」", "a": "彆"},
            {"q": "「ㄓˋ」息萬變的「ㄓˋ」怎麼寫？", "a": "瞬"},
            {"q": "成語填空：「〇」竿見影", "a": "立"},
            {"q": "「ㄌㄧㄠˊ」闊的「ㄌㄧㄠˊ」正確寫法？", "a": "遼"},
            {"q": "請寫出「蹣跚」的「蹣」", "a": "蹣"},
            {"q": "「嫻」熟的「嫻」怎麼寫？", "a": "嫻"},
            {"q": "成語填空：「〇」精會神", "a": "聚"},
            {"q": "「ㄐㄧㄝˊ」然不同的「ㄐㄧㄝˊ」正確寫法？", "a": "迥"},
            {"q": "請寫出「懾」服的「懾」", "a": "懾"},
            {"q": "「ㄑㄧˋ」而不捨的「ㄑㄧˋ」怎麼寫？", "a": "契"},
            {"q": "成語填空：「〇」手可得", "a": "唾"},
            {"q": "「ㄒㄩㄢ」嘩的「ㄒㄩㄢ」正確寫法？", "a": "喧"},
            {"q": "請寫出「慷慨」的「慨」", "a": "慨"},
            {"q": "「惆悵」的「惆」怎麼寫？", "a": "惆"},
            {"q": "成語填空：「〇」然大悟", "a": "恍"},
            {"q": "「ㄆㄧˇ」睨的「ㄆㄧˇ」正確寫法？", "a": "睥"},
            {"q": "請寫出「蹙」額的「蹙」", "a": "蹙"},
            {"q": "「ㄅㄧˋ」端的「ㄅㄧˋ」怎麼寫？", "a": "弊"},
            {"q": "成語填空：「〇」張聲勢", "a": "虛"},
            {"q": "「ㄔㄢˊ」悔的「ㄔㄢˊ」正確寫法？", "a": "懺"},
            {"q": "請寫出「嘲諷」的「諷」", "a": "諷"},
            {"q": "「怠惰」的「惰」怎麼寫？", "a": "惰"},
            {"q": "成語填空：「〇」飛猛進", "a": "突"},
            {"q": "「ㄒㄧㄝˋ」渎的「ㄒㄧㄝˋ」正確寫法？", "a": "褻"},
            {"q": "請寫出「訕笑」的「訕」", "a": "訕"},
            {"q": "「ㄉㄧㄝˊ」盪的「ㄉㄧㄝˊ」怎麼寫？", "a": "跌"},
            {"q": "成語填空：「〇」木求魚", "a": "緣"},
            {"q": "「ㄌㄧㄣˊ」憫的「ㄌㄧㄣˊ」正確寫法？", "a": "憐"},
            {"q": "請寫出「嫉妒」的「嫉」", "a": "嫉"},
            {"q": "「譏諷」的「譏」怎麼寫？", "a": "譏"},
            {"q": "成語填空：「〇」衷共濟", "a": "同"},
            {"q": "「ㄓㄜˊ」磨的「ㄓㄜˊ」正確寫法？", "a": "折"},
            {"q": "請寫出「慰藉」的「藉」", "a": "藉"},
            {"q": "「ㄋㄧㄝˋ」手ㄋㄧㄝˋ腳的「ㄋㄧㄝˋ」怎麼寫？", "a": "躡"},
            {"q": "成語填空：「〇」途末路", "a": "窮"},
            {"q": "「ㄏㄨㄟˋ」澀的「ㄏㄨㄟˋ」正確寫法？", "a": "晦"},
            {"q": "請寫出「瑕疵」的「疵」", "a": "疵"},
            {"q": "「詭」辯的「詭」怎麼寫？", "a": "詭"},
            {"q": "成語填空：「〇」極泰來", "a": "否"},
            {"q": "「ㄐㄧㄢˇ」樸的「ㄐㄧㄢˇ」正確寫法？", "a": "儉"},
            {"q": "請寫出「揶揄」的「揄」", "a": "揄"},
            {"q": "「斟酌」的「酌」怎麼寫？", "a": "酌"},
            {"q": "成語填空：「〇」瓜爛熟", "a": "滾"},
            {"q": "「ㄆㄧㄢˊ」祖的「ㄆㄧㄢˊ」正確寫法？", "a": "駢"},
            {"q": "請寫出「癖好」的「癖」", "a": "癖"},
            {"q": "「諂媚」的「諂」怎麼寫？", "a": "諂"},
            {"q": "成語填空：「〇」然紙上", "a": "躍"},
            {"q": "「ㄒㄧㄝˊ」帶的「ㄒㄧㄝˊ」正確寫法？", "a": "挾"},
            {"q": "請寫出「蟄伏」的「蟄」", "a": "蟄"},
            {"q": "「饜足」的「饜」怎麼寫？", "a": "饜"},
            {"q": "成語填空：「〇」貫而入", "a": "魚"},
            {"q": "「ㄓㄨㄛˊ」磨的「ㄓㄨㄛˊ」正確寫法？", "a": "琢"},
            {"q": "請寫出「倔強」的「倔」", "a": "倔"},
            {"q": "「嘮叨」的「嘮」怎麼寫？", "a": "嘮"},
            {"q": "成語填空：「〇」不單行", "a": "禍"},
            {"q": "「ㄐㄧㄡˋ」疾的「ㄐㄧㄡˋ」正確寫法？", "a": "痼"},
            {"q": "請寫出「綺麗」的「綺」", "a": "綺"},
            {"q": "「躊躇」的「躇」怎麼寫？", "a": "躇"},
            {"q": "成語填空：「〇」羽而歸", "a": "鎩"},
            {"q": "「ㄐㄧㄠˇ」倖的「ㄐㄧㄠˇ」正確寫法？", "a": "僥"},
            {"q": "請寫出「嗔怪」的「嗔」", "a": "嗔"},
            {"q": "「霎時」的「霎」怎麼寫？", "a": "霎"},
            {"q": "成語填空：「〇〇」不忘", "a": "念念"},
            {"q": "「ㄒㄧㄣ」賞的「ㄒㄧㄣ」正確寫法？", "a": "欣"},
            {"q": "請寫出「窘迫」的「窘」", "a": "窘"},
            {"q": "「詆毀」的「詆」怎麼寫？", "a": "詆"},
            {"q": "成語填空：「〇」不吐，快不為快", "a": "一"},
            {"q": "「ㄋㄧˇ」稱的「ㄋㄧˇ」正確寫法？", "a": "擬"},
            {"q": "請寫出「譴責」的「譴」", "a": "譴"},
            {"q": "「癱瘓」的「癱」怎麼寫？", "a": "癱"},
            {"q": "成語填空：「〇」落不明", "a": "下"},
            {"q": "「ㄅㄛˊ」取的「ㄅㄛˊ」正確寫法？", "a": "剝"},
            {"q": "請寫出「啜泣」的「啜」", "a": "啜"},
            {"q": "「慫恿」的「慫」怎麼寫？", "a": "慫"},
            {"q": "成語填空：「〇」落有致", "a": "錯"},
            {"q": "「ㄏㄨㄟˇ」諧的「ㄏㄨㄟˇ」正確寫法？", "a": "詼"},
            {"q": "請寫出「踹踏」的「踹」", "a": "踹"},
            {"q": "「賑災」的「賑」怎麼寫？", "a": "賑"},
            {"q": "成語填空：「〇」不經心", "a": "漫"},
            {"q": "「ㄉㄧㄝˊ」次的「ㄉㄧㄝˊ」正確寫法？", "a": "迭"},
            {"q": "請寫出「敷衍」的「敷」", "a": "敷"},
            {"q": "「躁動」的「躁」怎麼寫？", "a": "躁"},
            {"q": "成語填空：「〇」息相關", "a": "息"},
            {"q": "「ㄙㄨˋ」然起敬的「ㄙㄨˋ」正確寫法？", "a": "肅"},
            {"q": "請寫出「贅述」的「贅」", "a": "贅"},
            {"q": "「嘈雜」的「嘈」怎麼寫？", "a": "嘈"},
            {"q": "成語填空：「〇」為觀止", "a": "嘆"},
            {"q": "「ㄒㄩㄢˋ」麗的「ㄒㄩㄢˋ」正確寫法？", "a": "絢"},
            {"q": "請寫出「悖論」的「悖」", "a": "悖"},
            {"q": "「戕害」的「戕」怎麼寫？", "a": "戕"},
            {"q": "成語填空：「〇」道而行", "a": "背"},
            {"q": "「ㄔㄢˋ」抖的「ㄔㄢˋ」正確寫法？", "a": "顫"},
            {"q": "請寫出「踉蹌」的「踉」", "a": "踉"}
        ];

        // PeerJS 設定
        let peer;
        let adminConn = null;
        let playerConns = [null, null, null];
        let scores = [0, 0, 0];
        let currentQuestion = null;
        let currentQuestionIndex = 0;
        let timerInterval = null;
        let timeLeft = 30;

        // Canvas contexts
        const canvases = [];
        const contexts = [];

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 初始化 Canvas
            for (let i = 1; i <= 3; i++) {
                const canvas = document.getElementById(`canvas${i}`);
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = '#FF6B35';
                ctx.lineWidth = 3;
                canvases.push(canvas);
                contexts.push(ctx);
            }

            // 生成粒子
            createParticles();

            // 初始化 PeerJS
            initPeer();
        });

        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (10 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }

        function initPeer() {
            // 生成簡單的 4 位數字 ID
            const simpleId = Math.floor(1000 + Math.random() * 9000).toString();
            
            peer = new Peer(simpleId);
            
            peer.on('open', (id) => {
                document.getElementById('displayPeerId').textContent = id;
                document.getElementById('headerPeerId').textContent = id;
                console.log('Host Peer ID:', id);
            });

            peer.on('connection', (conn) => {
                conn.on('data', (data) => {
                    handleIncomingData(conn, data);
                });

                conn.on('open', () => {
                    console.log('Connection established with:', conn.peer);
                });
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                // 如果 ID 已被使用，重新生成
                if (err.type === 'unavailable-id') {
                    const newId = Math.floor(1000 + Math.random() * 9000).toString();
                    peer = new Peer(newId);
                } else {
                    alert('連線錯誤：' + err.message);
                }
            });
        }

        function handleIncomingData(conn, data) {
            if (data.type === 'identify') {
                if (data.role === 'admin') {
                    adminConn = conn;
                    document.getElementById('adminDot').classList.add('active');
                    document.getElementById('waitingScreen').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'flex';
                    updateStatus('管理員已連線');
                } else if (data.role === 'player') {
                    const playerIndex = data.playerNumber - 1;
                    playerConns[playerIndex] = conn;
                    document.getElementById(`player${data.playerNumber}Dot`).classList.add('active');
                    document.getElementById(`player${data.playerNumber}Card`).classList.add('connected');
                    updateStatus(`選手 ${data.playerNumber} 已連線`);
                }
            } else if (data.type === 'nextQuestion') {
                startNewQuestion(data.questionIndex);
            } else if (data.type === 'stroke') {
                drawStroke(data.playerNumber, data.stroke);
            } else if (data.type === 'submit') {
                handleSubmission(data.playerNumber, data.character);
            } else if (data.type === 'appeal') {
                handleAppeal(data.playerNumber);
            } else if (data.type === 'override') {
                handleOverride(data.playerNumber, data.correct);
            } else if (data.type === 'clear') {
                clearPlayerCanvas(data.playerNumber);
            }
        }

        function startNewQuestion(questionIndex) {
            if (questionIndex >= QUESTIONS.length) {
                updateStatus('所有題目已完成！');
                return;
            }

            currentQuestionIndex = questionIndex;
            currentQuestion = QUESTIONS[questionIndex];
            
            document.getElementById('questionNumber').textContent = questionIndex + 1;
            document.getElementById('questionText').textContent = currentQuestion.q;

            // 清空所有選手的畫布和結果
            for (let i = 1; i <= 3; i++) {
                clearPlayerCanvas(i);
                const resultDiv = document.getElementById(`result${i}`);
                resultDiv.className = 'result-display waiting';
                resultDiv.innerHTML = '<div class="result-char">---</div><div class="result-status">等待中</div>';
                document.getElementById(`player${i}Card`).classList.remove('appeal');
            }

            // 重置計時器
            startTimer();

            // 通知所有選手新題目
            broadcastToPlayers({
                type: 'newQuestion',
                question: currentQuestion.q,
                questionNumber: questionIndex + 1
            });
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timeLeft = 30;
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('timer').classList.remove('warning');

            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 10) {
                    document.getElementById('timer').classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    updateStatus('時間到！');
                }
            }, 1000);
        }

        function drawStroke(playerNumber, stroke) {
            const ctx = contexts[playerNumber - 1];
            const canvas = canvases[playerNumber - 1];

            ctx.beginPath();
            ctx.moveTo(stroke.x * canvas.width, stroke.y * canvas.height);
            ctx.lineTo(stroke.x2 * canvas.width, stroke.y2 * canvas.height);
            ctx.stroke();
        }

        function handleSubmission(playerNumber, character) {
            const correct = (character === currentQuestion.a);
            const resultDiv = document.getElementById(`result${playerNumber}`);
            
            resultDiv.className = `result-display ${correct ? 'correct' : 'incorrect'}`;
            resultDiv.innerHTML = `
                <div class="result-char">${character}</div>
                <div class="result-status">${correct ? '✓ 正確' : '✗ 錯誤'}</div>
            `;

            if (correct) {
                scores[playerNumber - 1] += 10;
                document.getElementById(`score${playerNumber}`).textContent = scores[playerNumber - 1];
                showScoreEffect(playerNumber, '+10');
            }

            // 通知該選手結果
            if (playerConns[playerNumber - 1]) {
                playerConns[playerNumber - 1].send({
                    type: 'result',
                    correct: correct
                });
            }
        }

        function handleAppeal(playerNumber) {
            document.getElementById(`player${playerNumber}Card`).classList.add('appeal');
            updateStatus(`選手 ${playerNumber} 請求審核！`);

            // 通知管理員
            if (adminConn) {
                adminConn.send({
                    type: 'appealNotification',
                    playerNumber: playerNumber
                });
            }
        }

        function handleOverride(playerNumber, correct) {
            document.getElementById(`player${playerNumber}Card`).classList.remove('appeal');
            
            const resultDiv = document.getElementById(`result${playerNumber}`);
            const currentChar = resultDiv.querySelector('.result-char').textContent;
            
            resultDiv.className = `result-display ${correct ? 'correct' : 'incorrect'}`;
            resultDiv.innerHTML = `
                <div class="result-char">${currentChar}</div>
                <div class="result-status">${correct ? '✓ 覆核通過' : '✗ 覆核駁回'}</div>
            `;

            if (correct) {
                const wasIncorrect = scores[playerNumber - 1] % 10 === 0; // 簡化判斷
                scores[playerNumber - 1] += 10;
                document.getElementById(`score${playerNumber}`).textContent = scores[playerNumber - 1];
                showScoreEffect(playerNumber, '+10');
            }

            // 通知選手
            if (playerConns[playerNumber - 1]) {
                playerConns[playerNumber - 1].send({
                    type: 'overrideResult',
                    correct: correct
                });
            }
        }

        function clearPlayerCanvas(playerNumber) {
            const ctx = contexts[playerNumber - 1];
            const canvas = canvases[playerNumber - 1];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function showScoreEffect(playerNumber, text) {
            const card = document.getElementById(`player${playerNumber}Card`);
            const rect = card.getBoundingClientRect();
            
            const effect = document.createElement('div');
            effect.className = 'score-effect';
            effect.textContent = text;
            effect.style.color = '#00FF88';
            effect.style.textShadow = '0 0 30px #00FF88';
            effect.style.left = rect.left + rect.width / 2 + 'px';
            effect.style.top = rect.top + rect.height / 2 + 'px';
            
            document.body.appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 1500);
        }

        function broadcastToPlayers(data) {
            playerConns.forEach(conn => {
                if (conn && conn.open) {
                    conn.send(data);
                }
            });
        }

        function updateStatus(message) {
            document.getElementById('statusMessage').textContent = message;
        }
    </script>
</body>
</html>
