<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>一字千金：書寫板</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #222; color: white; text-align: center; margin: 0; }
        #canvas { background: white; touch-action: none; margin-top: 10px; border-radius: 10px; }
        input { font-size: 1.2em; padding: 10px; width: 60%; }
        button { font-size: 1.2em; padding: 15px 30px; margin: 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; }
        .btn-send { background: #4ade80; }
        .btn-clear { background: #f87171; }
    </style>
</head>
<body>
    <div id="setup">
        <h2>輸入電腦端 ID 連線</h2>
        <input type="text" id="target-id" placeholder="例如: 8a2f...">
        <button onclick="connectHost()">連線</button>
    </div>

    <div id="game-area" style="display:none;">
        <canvas id="canvas"></canvas>
        <div>
            <button class="btn-clear" onclick="clearCanvas()">重寫</button>
            <button class="btn-send" onclick="recognizeAndSend()">送出答案</button>
        </div>
        <p id="msg">請等待題目...</p>
    </div>

    <script>
        let peer, conn, strokes = [];
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function connectHost() {
            const id = document.getElementById('target-id').value;
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(id);
                conn.on('open', () => {
                    document.getElementById('setup').style.display = 'none';
                    document.getElementById('game-area').style.display = 'block';
                    initCanvas();
                });
                conn.on('data', data => {
                    if(data.type === 'new_question') {
                        clearCanvas();
                        document.getElementById('msg').innerText = "請作答！";
                    }
                });
            });
        }

        function initCanvas() {
            canvas.width = window.innerWidth * 0.9;
            canvas.height = window.innerHeight * 0.6;
            ctx.lineWidth = 10;
            ctx.lineCap = 'round';
            ctx.strokeStyle = 'black';

            canvas.addEventListener('pointerdown', e => {
                drawing = true;
                const x = e.clientX - canvas.offsetLeft;
                const y = e.clientY - canvas.offsetTop;
                strokes.push([x], [y]);
                ctx.beginPath();
                ctx.moveTo(x, y);
            });

            canvas.addEventListener('pointermove', e => {
                if (!drawing) return;
                const x = e.clientX - canvas.offsetLeft;
                const y = e.clientY - canvas.offsetTop;
                ctx.lineTo(x, y);
                ctx.stroke();
                strokes[strokes.length - 2].push(x);
                strokes[strokes.length - 1].push(y);
            });

            canvas.addEventListener('pointerup', () => drawing = false);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            strokes = [];
        }

        async function recognizeAndSend() {
            document.getElementById('msg').innerText = "辨識中...";
            const url = `https://www.google.com.tw/inputtools/request?ime=zh-hant-t-i0-handwrit&app=mobilesearch`;
            const data = {
                "itc": "zh-hant-t-i0-handwrit",
                "num_results": 1,
                "requests": [{
                    "writing_guide": { "writing_area_width": canvas.width, "writing_area_height": canvas.height },
                    "ink": [strokes]
                }]
            };

            try {
                const response = await fetch(url, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'application/json' } });
                const result = await response.json();
                if (result[0] === "SUCCESS") {
                    const char = result[1][0][1][0];
                    conn.send({ type: 'answer', val: char });
                    document.getElementById('msg').innerText = "答案已送出！";
                }
            } catch (e) {
                alert("辨識失敗，請檢查網路！");
            }
        }
    </script>
</body>
</html>
