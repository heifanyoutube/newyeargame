<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>一字千金 | 選手端</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        :root{
            --primary:#FF6B35;--secondary:#F7931E;--accent:#FFD23F;
            --correct:#00FF88;--incorrect:#FF3366;
            --bg:linear-gradient(135deg,#0A0E27 0%,#1a1f3a 100%);
        }
        body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:white;
            overflow:hidden;position:fixed;width:100%;height:100%;}

        /* ── Connect Screen ── */
        .conn-screen{display:flex;flex-direction:column;justify-content:center;
            align-items:center;height:100vh;padding:28px;gap:16px;}
        .conn-screen h1{font-family:'Orbitron',sans-serif;font-size:clamp(2rem,7vw,2.8rem);
            background:linear-gradient(135deg,var(--primary),var(--secondary),var(--accent));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
            text-align:center;margin-bottom:10px;}

        .field{width:100%;max-width:420px;}
        .field label{display:block;color:var(--accent);font-size:.78rem;margin-bottom:6px;
            text-transform:uppercase;letter-spacing:1px;}
        .field input{width:100%;padding:14px;background:rgba(0,0,0,.7);
            border:2px solid rgba(255,107,53,.3);border-radius:10px;color:white;
            font-size:clamp(1rem,3.5vw,1.2rem);font-family:'Orbitron',monospace;transition:border-color .2s;}
        .field input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 18px rgba(255,107,53,.25);}

        .conn-btn{width:100%;max-width:420px;padding:17px;
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            border:none;border-radius:12px;color:white;font-size:clamp(1rem,3vw,1.15rem);
            font-weight:700;cursor:pointer;box-shadow:0 5px 22px rgba(255,107,53,.4);
            text-transform:uppercase;}
        .conn-btn:active{transform:scale(.98);}
        .conn-msg{font-size:.88rem;color:var(--accent);margin-top:5px;text-align:center;}
        .conn-msg.err{color:var(--incorrect);}

        /* ── Game Screen ── */
        .game{display:none;flex-direction:column;height:100vh;}
        .game.active{display:flex;}

        .g-header{display:flex;justify-content:space-between;align-items:center;
            padding:13px 18px;background:rgba(0,0,0,.75);border-bottom:2px solid var(--primary);}
        .badge{font-family:'Orbitron',sans-serif;font-size:clamp(.9rem,2.5vw,1.1rem);
            font-weight:900;color:var(--primary);text-shadow:0 0 10px rgba(255,107,53,.5);}
        .q-info{flex:1;text-align:center;padding:0 10px;}
        .q-num{font-size:clamp(.65rem,1.8vw,.78rem);color:var(--accent);margin-bottom:4px;}
        .q-txt{font-size:clamp(.82rem,2.2vw,1rem);font-weight:700;line-height:1.4;}
        .conn-dot{width:13px;height:13px;border-radius:50%;background:#444;flex-shrink:0;}
        .conn-dot.on{background:var(--correct);box-shadow:0 0 12px var(--correct);}

        /* ── Canvas Area ── */
        .canvas-wrap{flex:1;position:relative;background:rgba(0,0,0,.25);overflow:hidden;}
        #drawCanvas{width:100%;height:100%;touch-action:none;cursor:crosshair;display:block;}

        .canvas-hint{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
            text-align:center;pointer-events:none;transition:opacity .3s;}
        .canvas-hint.hide{opacity:0;}
        .hint-icon{font-size:4.5rem;margin-bottom:15px;opacity:.35;}
        .hint-txt{font-size:1.3rem;color:var(--accent);opacity:.5;}

        /* ── Controls ── */
        .controls{display:flex;gap:10px;padding:13px;
            background:rgba(0,0,0,.82);border-top:2px solid rgba(255,107,53,.25);}
        .ctrl-btn{flex:1;padding:17px;border:none;border-radius:11px;
            font-size:clamp(.85rem,2.2vw,1rem);font-weight:700;cursor:pointer;
            text-transform:uppercase;transition:all .2s;}
        .ctrl-btn:active{transform:scale(.95);}
        .btn-clr{background:rgba(255,255,255,.1);color:white;border:2px solid rgba(255,255,255,.25);}
        .btn-sub{background:linear-gradient(135deg,var(--correct),#00CC6A);color:white;
            box-shadow:0 4px 18px rgba(0,255,136,.3);}
        .btn-sub:disabled{opacity:.45;cursor:not-allowed;}
        .btn-appeal{background:linear-gradient(135deg,var(--accent),#FFA500);color:#0A0E27;
            box-shadow:0 4px 18px rgba(255,211,63,.3);display:none;}
        .btn-appeal.show{display:block;}

        /* ── Result Overlay ── */
        .result-ov{position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.96);display:none;justify-content:center;
            align-items:center;flex-direction:column;z-index:500;}
        .result-ov.show{display:flex;}
        .r-icon{font-size:7rem;margin-bottom:25px;animation:rpop .5s ease-out;}
        @keyframes rpop{0%{transform:scale(0) rotate(-180deg);}60%{transform:scale(1.2) rotate(10deg);}100%{transform:scale(1) rotate(0);}}
        .r-word{font-family:'Orbitron',sans-serif;font-size:clamp(2rem,7vw,3rem);font-weight:900;margin-bottom:15px;}
        .r-msg{font-size:1.1rem;color:rgba(255,255,255,.65);}
        .result-ov.correct .r-icon,.result-ov.correct .r-word{color:var(--correct);text-shadow:0 0 30px var(--correct);}
        .result-ov.incorrect .r-icon,.result-ov.incorrect .r-word{color:var(--incorrect);text-shadow:0 0 30px var(--incorrect);}

        /* ── Recognizing Overlay ── */
        .recog-ov{position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.9);display:none;justify-content:center;
            align-items:center;flex-direction:column;z-index:600;gap:20px;}
        .recog-ov.show{display:flex;}
        .spinner{width:70px;height:70px;border:5px solid rgba(255,107,53,.2);
            border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg);}}
        .recog-txt{color:var(--accent);font-size:1.3rem;}
    </style>
</head>
<body>

<!-- Connect Screen -->
<div class="conn-screen" id="connScreen">
    <h1>選手端</h1>
    <div class="field">
        <label>Database URL</label>
        <input id="dbUrl" type="url" placeholder="https://your-project-default-rtdb.firebaseio.com">
    </div>
    <div class="field">
        <label>API Key</label>
        <input id="apiKey" type="text" placeholder="AIzaSy...">
    </div>
    <div class="field">
        <label>房間代號（4 位數字）</label>
        <input id="roomInput" type="number" inputmode="numeric" maxlength="4" placeholder="例如：1234">
    </div>
    <div class="field">
        <label>選手編號</label>
        <input id="playerNum" type="number" inputmode="numeric" min="1" max="3" placeholder="1、2 或 3">
    </div>
    <button class="conn-btn" onclick="connect()">連線開始</button>
    <div class="conn-msg" id="connMsg"></div>
</div>

<!-- Game Screen -->
<div class="game" id="game">
    <div class="g-header">
        <div class="badge" id="badge">選手 1</div>
        <div class="q-info">
            <div class="q-num" id="qNum">等待題目...</div>
            <div class="q-txt" id="qTxt"></div>
        </div>
        <div class="conn-dot" id="connDot"></div>
    </div>

    <div class="canvas-wrap">
        <canvas id="drawCanvas"></canvas>
        <div class="canvas-hint" id="hint">
            <div class="hint-icon">✍️</div>
            <div class="hint-txt">等待題目開始</div>
        </div>
    </div>

    <div class="controls">
        <button class="ctrl-btn btn-clr" id="clrBtn" onclick="clearCanvas()">清除</button>
        <button class="ctrl-btn btn-sub" id="subBtn" disabled onclick="submitAnswer()">送出答案</button>
        <button class="ctrl-btn btn-appeal" id="appealBtn" onclick="sendAppeal()">請求審核</button>
    </div>
</div>

<!-- Recognizing Overlay -->
<div class="recog-ov" id="recogOv">
    <div class="spinner"></div>
    <div class="recog-txt">辨識中...</div>
</div>

<!-- Result Overlay -->
<div class="result-ov" id="resultOv">
    <div class="r-icon" id="rIcon">✓</div>
    <div class="r-word" id="rWord">正確！</div>
    <div class="r-msg" id="rMsg">+10 分</div>
</div>

<script>
let db, roomId, playerNum;
let canvas, ctx;
let isDrawing=false, lastX=0, lastY=0;
let strokes=[], curStroke=[];
let canSubmit=false, isSubmitting=false;
let resultListener=null;

// ── Connect ──
function connect(){
    const dbUrl=document.getElementById('dbUrl').value.trim();
    const apiKey=document.getElementById('apiKey').value.trim();
    const roomIn=document.getElementById('roomInput').value.trim();
    const pn=parseInt(document.getElementById('playerNum').value);
    const msg=document.getElementById('connMsg');

    if(!dbUrl||!apiKey||!roomIn||!pn){setMsg('請填入所有欄位','err');return;}
    if(roomIn.length!==4||!/^\d+$/.test(roomIn)){setMsg('房間代號必須是 4 位數字','err');return;}
    if(pn<1||pn>3){setMsg('選手編號必須是 1、2 或 3','err');return;}

    playerNum=pn;
    roomId=roomIn;
    setMsg('連線中...');

    try{
        if(firebase.apps.length===0){
            firebase.initializeApp({apiKey,databaseURL:dbUrl,
                projectId:dbUrl.replace('https://','').split('.')[0]});
        }
        db=firebase.database();

        db.ref(`rooms/${roomId}/status`).once('value',snap=>{
            if(!snap.exists()){setMsg('找不到該房間','err');return;}
            // Register player
            db.ref(`rooms/${roomId}/connections/p${playerNum}`).set(true);
            db.ref(`rooms/${roomId}/connections/p${playerNum}`).onDisconnect().set(false);

            // Switch to game screen
            document.getElementById('connScreen').style.display='none';
            document.getElementById('game').classList.add('active');
            document.getElementById('badge').textContent=`選手 ${playerNum}`;
            document.getElementById('connDot').classList.add('on');

            initCanvas();
            listenQuestion();
            listenResult();
        });
    }catch(e){setMsg('錯誤：'+e.message,'err');}
}

function setMsg(t,type=''){
    const el=document.getElementById('connMsg');
    el.textContent=t;el.className='conn-msg'+(type?' '+type:'');
}

// ── Canvas ──
function initCanvas(){
    canvas=document.getElementById('drawCanvas');
    const wrap=canvas.parentElement;
    canvas.width=wrap.offsetWidth;
    canvas.height=wrap.offsetHeight;
    ctx=canvas.getContext('2d');
    ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle='#FF6B35';ctx.lineWidth=4;

    // Touch
    canvas.addEventListener('touchstart',onStart,{passive:false});
    canvas.addEventListener('touchmove',onMove,{passive:false});
    canvas.addEventListener('touchend',onEnd);
    // Mouse
    canvas.addEventListener('mousedown',onStart);
    canvas.addEventListener('mousemove',onMove);
    canvas.addEventListener('mouseup',onEnd);
    canvas.addEventListener('mouseleave',onEnd);
}

function getPos(e){
    const r=canvas.getBoundingClientRect();
    if(e.touches&&e.touches.length>0) return{x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top};
    return{x:e.clientX-r.left,y:e.clientY-r.top};
}

function onStart(e){
    if(!canSubmit)return;
    e.preventDefault();
    isDrawing=true;
    const p=getPos(e);
    lastX=p.x;lastY=p.y;
    curStroke=[{x:p.x/canvas.width,y:p.y/canvas.height,t:Date.now()}];
    document.getElementById('hint').classList.add('hide');
}

function onMove(e){
    if(!isDrawing||!canSubmit)return;
    e.preventDefault();
    const p=getPos(e);
    ctx.beginPath();ctx.moveTo(lastX,lastY);ctx.lineTo(p.x,p.y);ctx.stroke();

    // Send stroke to Firebase
    if(db&&roomId){
        db.ref(`rooms/${roomId}/strokes/p${playerNum}`).push({
            x:lastX/canvas.width,y:lastY/canvas.height,
            x2:p.x/canvas.width,y2:p.y/canvas.height
        });
    }

    curStroke.push({x:p.x/canvas.width,y:p.y/canvas.height,t:Date.now()});
    lastX=p.x;lastY=p.y;
}

function onEnd(){
    if(isDrawing&&curStroke.length>0){strokes.push([...curStroke]);}
    isDrawing=false;curStroke=[];
}

function clearCanvas(){
    if(ctx&&canvas)ctx.clearRect(0,0,canvas.width,canvas.height);
    strokes=[];curStroke=[];
    document.getElementById('hint').classList.remove('hide');
    if(db&&roomId) db.ref(`rooms/${roomId}/strokes/p${playerNum}`).remove();
}

// ── Firebase listeners ──
function listenQuestion(){
    db.ref(`rooms/${roomId}/currentQuestion`).on('value',snap=>{
        const q=snap.val();
        if(!q)return;
        document.getElementById('qNum').textContent=`第 ${q.number} 題`;
        document.getElementById('qTxt').textContent=q.text;
        // Reset state
        clearCanvas();
        canSubmit=true;isSubmitting=false;
        document.getElementById('subBtn').disabled=false;
        document.getElementById('appealBtn').classList.remove('show');
        hideResult();
    });
}

function listenResult(){
    db.ref(`rooms/${roomId}/results/p${playerNum}`).on('value',snap=>{
        const r=snap.val();
        if(!r||!r.ts)return;
        showResult(r.correct, r.overridden);
    });
}

// ── Submit ──
async function submitAnswer(){
    if(!canSubmit||strokes.length===0){alert('請先書寫答案');return;}
    if(isSubmitting)return;
    isSubmitting=true;
    canSubmit=false;
    document.getElementById('subBtn').disabled=true;
    document.getElementById('recogOv').classList.add('show');

    try{
        const char=await recognize();
        document.getElementById('recogOv').classList.remove('show');
        db.ref(`rooms/${roomId}/submissions`).push({
            playerNumber:playerNum,character:char,ts:Date.now(),
            id:Date.now().toString()
        });
    }catch(err){
        document.getElementById('recogOv').classList.remove('show');
        alert('辨識失敗：'+err.message+'\n請重新書寫後再試');
        canSubmit=true;isSubmitting=false;
        document.getElementById('subBtn').disabled=false;
    }
}

async function recognize(){
    // Build ink data from all strokes
    if(strokes.length===0)throw new Error('沒有筆畫資料');

    const ink=strokes.map(stroke=>[
        stroke.map(p=>Math.round(p.x*1000)),
        stroke.map(p=>Math.round(p.y*1000))
    ]);

    const body=JSON.stringify({
        options:'enable_pre_space',
        requests:[{
            writing_guide:{writing_area_width:1000,writing_area_height:1000},
            ink:ink,
            language:'zh_TW'
        }]
    });

    const res=await fetch('https://inputtools.google.com/request?ime=handwriting&app=mobilesearch&cs=1&oe=UTF-8',{
        method:'POST',headers:{'Content-Type':'application/json'},body
    });
    const data=await res.json();
    console.log('Recognition result:',data);

    if(data&&data[1]&&data[1][0]&&data[1][0][1]&&data[1][0][1].length>0){
        return data[1][0][1][0];
    }
    throw new Error('無法識別，請重新書寫');
}

// ── Appeal ──
function sendAppeal(){
    db.ref(`rooms/${roomId}/appeals`).push({playerNumber:playerNum,ts:Date.now()});
    document.getElementById('appealBtn').disabled=true;
    document.getElementById('appealBtn').textContent='審核中...';
}

// ── Result display ──
function showResult(correct,overridden=false){
    const ov=document.getElementById('resultOv');
    ov.className='result-ov show '+(correct?'correct':'incorrect');
    document.getElementById('rIcon').textContent=correct?'✓':'✗';
    document.getElementById('rWord').textContent=overridden?(correct?'審核通過！':'審核駁回'):(correct?'正確！':'錯誤！');
    document.getElementById('rMsg').textContent=correct?'+10 分':'繼續加油';
    if(!correct&&!overridden){
        document.getElementById('appealBtn').classList.add('show');
        document.getElementById('appealBtn').disabled=false;
        document.getElementById('appealBtn').textContent='請求審核';
    }
    setTimeout(hideResult,3500);
}

function hideResult(){
    const ov=document.getElementById('resultOv');
    ov.style.display='none';
    ov.className='result-ov';
}

window.addEventListener('resize',()=>{
    if(canvas&&ctx){
        const w=canvas.parentElement.offsetWidth;
        const h=canvas.parentElement.offsetHeight;
        const img=ctx.getImageData(0,0,canvas.width,canvas.height);
        canvas.width=w;canvas.height=h;
        ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle='#FF6B35';ctx.lineWidth=4;
        try{ctx.putImageData(img,0,0);}catch(e){}
    }
});
</script>
</body>
</html>
